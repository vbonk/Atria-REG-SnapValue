### # Final Unified Prompt for Developer AI Agent: Build the SnapValue Application

**Project Objective:**
Your mission is to build the SnapValue application, a lead-generation tool for REALTOR® Anne Marie Velte. The final product will be a monolithic full-stack application based on the provided specifications.

* **Production URL**: `https://snapvalue.agenttoolbox.ai`
* **Staging URL**: `https://staging.snapvalue.agenttoolbox.ai`

## 1. Repository and Architecture

Implement the specified mono-repo structure with three top-level directories. The backend will be a Node.js/Express monolith that serves both the API and the static React frontend.

```
root/
 ├─ client/   # React 18 + Vite + Tailwind + shadcn/ui
 ├─ server/   # Node.js 18 + Express monolith
 └─ infra/    # Dockerfile, railway.json, GitHub Actions, cleanup.ts
```

## 2. Backend API Implementation

| Route | Method | Purpose | Details |
|-------|--------|---------|---------|
| `/api/analyze` | POST | Accept images & property details | Rate-limited, calls AI_GATEWAY, returns `{reportId}` |
| `/api/lead` | POST | Save contact info & send email | Creates Lead record, triggers notification |
| `/api/report/:id/pdf` | GET | Stream branded PDF | Generated by Puppeteer with REALTOR® branding |
| `/api/privacy/delete/:leadId` | DELETE | GDPR/CCPA compliance | Hard-delete all associated data |
| `/healthz` | GET | Health check | Returns `{status:"ok", uptime, db:true\|false}` |

### Rate Limit Headers
Rate-limited endpoints must return:
- `X-RateLimit-Limit-Hour`
- `X-RateLimit-Remaining-Hour`
- `X-RateLimit-Limit-Day`
- `X-RateLimit-Remaining-Day`

## 3. Core Service Implementation

| Service | Requirements |
|---------|--------------|
| **Rate Limiting** | Apply to `/api/analyze` using `express-rate-limit`. Configurable: `REPORTS_PER_HOUR`, `REPORTS_PER_DAY` |
| **Database** | Postgres with Prisma ORM. Tables: `Lead`, `Report`, `Image` |
| **AI Gateway** | Multi-provider with automatic failover chain from `PROVIDER_CHAIN` env var. Hard cap: `MAX_COST_USD_PER_REPORT` |
| **Storage Provider** | Interface pattern with drivers: `local` (Railway volume) and `s3` (stub). Selected via `STORAGE_DRIVER` |
| **PDF Generation** | Puppeteer renders server-side HTML to vector PDF with header, footer, CTA button, REALTOR® designation |
| **Email Provider** | Interface pattern with drivers: `resend` (default) and `smtp`. Selected via `EMAIL_PROVIDER` |
| **Logging** | Winston JSON to `/logs/app.log` with reqId, leadId, event, aiCost |
| **Validation** | Image MIME type verification, magic byte checking, Zod schema validation for JSON payloads |

### AI Gateway Specifics
- **Provider Chain**: Use `PROVIDER_CHAIN` env var (e.g., `"openai,gemini,anthropic,openrouter"`)
- **Auto-Failover**: On provider error, automatically try next in chain
- **Cost Control**: Abort if projected cost > `MAX_COST_USD_PER_REPORT`
- **Spend Monitoring**: Track daily spend, trigger alert if > `DAILY_COST_ALERT_USD`

## 4. Operational Monitoring & Alerting

### Spend Monitoring
- Track cumulative daily AI costs
- When daily spend exceeds `DAILY_COST_ALERT_USD`:
  - If `SPEND_ALERT_CHANNEL=log`: Log critical alert
  - If `SPEND_ALERT_CHANNEL=email`: Send email to `OPS_ALERT_EMAIL`
- Reset counter at midnight UTC

### Health Monitoring
- `/healthz` endpoint for uptime monitoring
- Include database connectivity check
- Return service degradation status if any provider is down

### Error Alerting
- Integration with Sentry if `SENTRY_DSN` is provided
- Critical errors trigger immediate alerts
- Error rate monitoring with thresholds

## 5. Data Retention & Tracking Rules

### Retention Policy
| Asset | Retention | Environment Variable |
|-------|-----------|---------------------|
| Original images | Configurable | `IMAGE_TTL_DAYS` |
| Generated PDFs | Configurable | `PDF_TTL_DAYS` |
| Database rows | Indefinite | Unless user requests deletion |

### Data Purging
* Daily cron job (`cleanup.ts`) runs at time specified by `CLEANUP_CRON_TIME` (cron format)
* GDPR endpoint immediately deletes all associated data
* Log `event=lead_deleted` for compliance tracking

### Anonymous → Tracked Flow
| Step | Status | Stored PII | GA4 Event |
|------|--------|------------|-----------|
| Wizard start | Anonymous | None | `report_started` |
| /api/analyze | Anonymous | None | `report_generated` |
| LeadCaptureModal submit | Tracked | Email/Phone | `lead_captured` |
| PDF download | Either | None extra | `pdf_downloaded` |

## 6. Frontend Tasks

* Remove all authentication artifacts from existing React UI
* Implement `<LeadCaptureModal>` component using shadcn/ui:
  - Fields: email, phone, "Please contact me" checkbox
  - Must include prominent "Skip" button
  - Shows after report generation, before PDF download
* Create 4-step wizard: photo upload → room tagging → details entry → final review
* Integrate Google Analytics 4 with separate properties for staging/production

## 7. Testing and CI/CD

### Testing Requirements
| Type | Requirements | Enforcement |
|------|--------------|-------------|
| **Unit Tests** | ≥90% coverage for AI_GATEWAY, PDF module, rate-limiting | Enforced via coverage gate |
| **E2E Tests** | Cypress happy-path for desktop and mobile | Required for deployment |
| **Integration Tests** | Test provider failover, spend alerts | Part of CI pipeline |

### CI/CD Pipeline (GitHub Actions)
```yaml
Pipeline stages:
1. Lint (ESLint + Prettier check)
2. Unit tests with coverage report
3. Coverage gate (fail if <90%)
4. Build application
5. Integration tests
6. Build Docker image
7. Deploy to staging (if main branch)
8. Run E2E tests against staging
9. Deploy to production (if release/* branch)
10. Post-deployment health check
```

### Deployment Strategy
- **Staging**: Auto-deploy on push to `main`
- **Production**: Deploy only from `release/*` branches
- **Rollback**: Maintain last 3 Docker images for quick rollback

## 8. Environment Variables

```bash
# AI Configuration
PROVIDER_CHAIN=openai,gemini,anthropic,openrouter
AI_PROVIDER=openai            # Primary provider
OPENAI_API_KEY=
GEMINI_API_KEY=
ANTHROPIC_API_KEY=
OPENROUTER_API_KEY=
MAX_COST_USD_PER_REPORT=0.20
DAILY_COST_ALERT_USD=10

# Operational Alerts
SPEND_ALERT_CHANNEL=log       # log | email
OPS_ALERT_EMAIL=snapvalue@atriarealestategroup.com

# Rate Limiting
REPORTS_PER_HOUR=20
REPORTS_PER_DAY=40

# Database
DATABASE_URL=postgres://...

# Storage
STORAGE_DRIVER=local          # local | s3
IMAGE_TTL_DAYS=30
PDF_TTL_DAYS=90
MAX_IMAGES=8
MAX_IMAGE_MB=10

# Email
EMAIL_PROVIDER=smtp         # resend | smtp
RESEND_API_KEY=
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASS=
LEAD_EMAIL=snapvalue@atriarealestategroup.com

# Analytics
GA_MEASUREMENT_ID=G-PROD123
GA_MEASUREMENT_ID_STAGING=G-STAGE123

# Application
NODE_ENV=production           # staging | production
PORT=8080

# Monitoring
SENTRY_DSN=
CLEANUP_CRON_TIME=0 2 * * *   # 02:00 UTC daily
```

## 9. Important Constraints & Edge Cases

* **File Upload Limits**: Max `MAX_IMAGES` images, `MAX_IMAGE_MB` per image, only JPG/PNG
* **Request Size Limit**: 80MB total request size limit
* **Cost Monitoring**: Alert if daily AI spend exceeds threshold
* **Provider Failover**: Automatic fallback through provider chain
* **Skip Option**: LeadCaptureModal must have prominent "Skip" button
* **Error Handling**: Log all errors with context, show user-friendly messages

## 10. Security Requirements

* **Input Sanitization**: Sanitize all user inputs before AI processing
* **File Validation**: Verify actual image content via magic bytes, not just extension
* **Rate Limit Headers**: Return quota information in response headers
* **CORS**: Configure for production and staging domains only
* **MIME Validation**: Strict validation of image/jpeg and image/png only

## 11. Development Milestones

| Week       | Deliverables                                                 |
|------------|--------------------------------------------------------------|
| **Unit 1** | Core API, health check, rate limiting, basic React scaffold  |
| **Unit 2** | AI gateway with failover, PDF generation skeleton, spend tracking |
| **Unit 3** | Database integration, lead capture flow, GA4 events          |
| **Unit 4** | Storage abstraction, TTL implementation, cron job, alerting system |
| **Unit 5** | Testing suite (90% coverage), CI/CD pipeline, staging deployment, production launch |

### Weekly Reporting
- Progress reports due every **Friday at 17:00 CT**
- Include: completed items, blockers, next week's goals, spend metrics

## 12. Operational Requirements

* **Monitoring**: 
  - Health checks every 60 seconds via `/healthz`
  - Uptime monitoring with 99.5% SLA target
  - Response time alerts if p95 > 3s
* **Alerting Channels**:
  - Spend overage alerts
  - Health check failures
  - Error rate spikes (>5% in 5 min window)
  - Deployment notifications
* **Logging**:
  - Structured JSON logs with correlation IDs
  - Log retention: 30 days
  - Critical logs forwarded to alerting system

## 13. Open Questions - Confirm Before Coding

1. **EMAIL_PROVIDER** preference: `smtp` (Google)
2. **STORAGE_DRIVER** at launch: `local` vs `s3`?
3. Provide: Logo SVG, brand colors (#hex values), REALTOR® headshot
4. Confirm: Exact Calendly URL for CTA button
5. Provide: GA4 staging property ID

## First Action

Begin by executing the kick-off command: Create the repository scaffold (`client/`, `server/`, `infra/`) complete with:
- `Dockerfile` for containerized deployment
- .env.local is in Users/tony/Projects/atria-reg-snapvalue with all variables listed above
- Basic Express server with `/healthz` endpoint
- Vite + React starter application
- Railway deployment configuration (`railway.json`)
- `cleanup.ts` cron script with configurable schedule
- GitHub Actions workflow with coverage gates
- Basic alerting configuration template

Push this initial structure to the following GitHub repository:
local:  Users/tony/Projects/atria-reg-snapvalue
remote: https://github.com/vbonk/Atria-REG-SnapValue
---

**Note**: This is a production application for a real business. Prioritize reliability, operational excellence, and user experience. Implement comprehensive monitoring and alerting to ensure issues are caught before they impact users. All user interactions should feel smooth and professional, reflecting positively on REALTOR® Anne Marie Velte and Atria Real Estate Group.
